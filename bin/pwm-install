#!/usr/bin/env node

require('colors')
var fs = require('fs')
var path = require('path')
var program = require('commander')
var find = require('find-parent-dir')
var request = require('hyperdirect').request
var unzip = require('decompress').extract
var glob = require('glob')
var rm = require('rimraf').sync
var database = require('../database')

program.option('--save', 'Add module to module.json file')
program.parse(process.argv)

var cwd = process.cwd()
var modules = path.join(cwd, 'site/modules')

var log = function(message, type, status) {
  console.log('pwm ' + [type ? type.green : '', status ? status.magenta : '', message].join(' '))
}

var fail = function(error) {
  console.error('pwm ' + error.message.red)
}

// Install an individual module
var install = function(error, module) {
  if (error) {
    fail(error)
    return
  }

  var directory = path.join(modules, module.class_name)

  // Download and unzip
  log(module.download_url, 'http', 'GET')
  request(module.download_url)
    .on('error', fail)
    .on('end', log.bind(log, module.download_url, 'http', '200'))
    .pipe(unzip({ ext: '.zip', path: directory }))
    .on('error', fail) 
    .on('close', function() {
      if (program.save) {
        // Find modules in json
        find(cwd, 'module.json', function(error, directory) {
          if (error || !directory) {
            var json_path = path.join(cwd, 'module.json')
            var json = {}
          }
          else { 
            var json_path = path.join(directory, 'module.json')
            var json = require(json_path) || {}
          }

          json.modules = json.modules || {}
          if (module.class_name in json.modules) {
            // Do something if will overide
          }
          else {
            json.modules[module.class_name] = '~' + module.module_version
            fs.writeFileSync(json_path, JSON.stringify(json, null, 2))
          }
        })
      }

      // Remove wrapping folder
      glob('*', { cwd: directory }, function(error, files) {
        if (files.length === 1) {
          var file = path.join(directory, files[0])
          fs.stat(file, function(error, stat) {
            if (error) {
              console.error(error.message)
              return
            }
            if (stat.isDirectory()) {
              var temp = path.join(
                modules, '.' + module.class_name
              ) 
              fs.renameSync(file, temp)
              rm(directory)
              fs.renameSync(temp, directory)
              console.log(
                module.class_name + '@' + module.module_version + ' ' +
                directory.replace(cwd + '/', '')
              )
            }
          })
        }
        else {
          console.log(
            module.class_name + '@' + module.module_version + ' ' +
            directory.replace(cwd + '/', '')
          )
        }
      }) 
    })
}

// Find modules passed into program
if (program.args.length) {
  return program.args.forEach(function(module) {
    database.find(module, install)
  })
}

// Find modules in json
find(cwd, 'module.json', function(error, directory) {
  if (error || !directory) {
    return fail(
      error || 'Couldnâ€™t find a module.json file.'
    )
  }

  var json = require(path.join(directory, 'module.json'))
  Object.keys(json.modules).forEach(function(module) {
    database.find([module, json.modules[module]].join('@'), install)
  })
})
